@model Models.Prestamo

@{
    ViewData["Title"] = "Ver Préstamo";
    var copiasLibros = ViewBag.CopiasLibros as List<Models.CopiaLibro>;
}


<style>
    .bg-custom {
        background-color: #8C2445 !important;
    }
    .text-custom {
        color: #8C2445 !important;
    }
    .card-header {
        background-color: #8C2445 !important;
        color: #fff !important;
    }
    .card-body .col-sm-4 strong {
        color: #8C2445 !important;
    }
    .main-title {
        color: #8C2445;
        margin-top: 2.5rem;
        margin-bottom: 1rem;
    }
</style>

<div class="container-fluid px-4">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-1 main-title">Detalles del Préstamo #@Model.IdPrestamo</h1>
            <div class="d-flex justify-content-end mb-4">
                <a asp-action="tablaPrestamos" asp-route-IdCliente="@Model.IdCliente" class="btn btn-link text-custom p-0" style="text-decoration: none; box-shadow: none;">
                    <i class="bi bi-arrow-left"></i> Volver
                </a>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Información del Préstamo -->
        <div class="col-lg-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Información del Préstamo</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-sm-4"><strong>ID Préstamo:</strong></div>
                        <div class="col-sm-8">@Model.IdPrestamo</div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-sm-4"><strong>Fecha Inicio:</strong></div>
                        <div class="col-sm-8">@Model.FechaInicio?.ToString("dd/MM/yyyy")</div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-sm-4"><strong>Fecha Límite:</strong></div>
                        <div class="col-sm-8">@Model.FechaLimite?.ToString("dd/MM/yyyy")</div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-sm-4"><strong>Estado:</strong></div>
                        <div class="col-sm-8">
                            <span class="@(Model.FechaLimite < DateTime.Now ? "text-danger fw-bold" : "text-success fw-bold")">
                                @(Model.FechaLimite < DateTime.Now ? "Vencido" : (Model.estadoPrestamo?.Descripcion ?? "Activo"))
                            </span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-4"><strong>Activo:</strong></div>
                        <div class="col-sm-8">
                            <span class="@(Model.Activo == true ? "text-success fw-bold" : "text-secondary fw-bold")">
                                @(Model.Activo == true ? "Sí" : "No")
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Libros Prestados -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Libros Prestados</h5>
                </div>
                <div class="card-body">
                    @if (copiasLibros != null && copiasLibros.Any())
                    {
                        @foreach (var copia in copiasLibros)
                        {
                            <div class="border rounded p-3 mb-3">
                                <div class="row">
                                    <div class="col-sm-4">
                                        <strong>Título:</strong>
                                    </div>
                                    <div class="col-sm-8">
                                        @(copia?.Libro?.Titulo ?? "Título no disponible")
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-sm-4">
                                        <strong>Descripción:</strong>
                                    </div>
                                    <div class="col-sm-8">
                                        @(copia?.Libro?.Descripcion ?? "Descripción no disponible")
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-sm-4">
                                        <strong>ISBN:</strong>
                                    </div>
                                    <div class="col-sm-8">
                                        @(copia?.Libro?.ISBN ?? "ISBN no disponible")
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-sm-4">
                                        <strong>Fecha Publicación:</strong>
                                    </div>
                                    <div class="col-sm-8">
                                        @(copia?.Libro?.FechaPublicacion?.ToString("dd/MM/yyyy") ?? "Fecha no disponible")
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-sm-4">
                                        <strong>Copia #:</strong>
                                    </div>
                                    <div class="col-sm-8">
                                        @copia?.IdCopiaLibro
                                    </div>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <p class="text-muted">No se encontraron libros asociados a este préstamo.</p>
                    }
                </div>
            </div>
        </div>

        <!-- Información del Cliente y Usuario -->
        <div class="col-lg-6">
            <!-- Cliente -->
            @if (Model.cliente != null)
            {
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Información del Cliente</h5>
                    </div>
                    <div class="card-body text-center">
                        @if (!string.IsNullOrEmpty(Model.cliente.URLImagen))
                        {
                            <img src="@(string.IsNullOrEmpty(Model.cliente.URLImagen) ? "/images/default-user.svg" : $"/Clientes/images/{Model.cliente.URLImagen}")"  alt="Cliente" class="rounded-circle mb-3" style="width: 80px; height: 80px; object-fit: cover;">
                        }
                        else
                        {
                            <img src="~/fotoperfil.jpg" alt="Cliente" class="rounded-circle mb-3" style="width: 80px; height: 80px; object-fit: cover;">
                        }
                        <h4>@Model.cliente.Nombre @Model.cliente.Apellido1 @Model.cliente.Apellido2</h4>
                        <div class="text-start mt-3">
                            <div class="row mb-2">
                                <div class="col-sm-4"><strong>Cédula:</strong></div>
                                <div class="col-sm-8">@Model.cliente.Cedula</div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-sm-4"><strong>Correo:</strong></div>
                                <div class="col-sm-8">@Model.cliente.Correo</div>
                            </div>
                            <div class="row">
                                <div class="col-sm-4"><strong>Teléfono:</strong></div>
                                <div class="col-sm-8">@Model.cliente.Telefono</div>
                            </div>
                        </div>
                    </div>
                </div>
            }

            <!-- Usuario -->
            @if (Model.usuario != null)
            {
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Efectuado por</h5>
                    </div>
                    <div class="card-body text-center">
                        @if (!string.IsNullOrEmpty(Model.usuario.UrlImagen))
                        {
                            <img src="@Model.usuario.UrlImagen" alt="Usuario" class="rounded-circle mb-3" style="width: 80px; height: 80px; object-fit: cover;">
                        }
                        else
                        {
                            <img src="~/fotoperfil.jpg" alt="Usuario" class="rounded-circle mb-3" style="width: 80px; height: 80px; object-fit: cover;">
                        }
                        <h4>@Model.usuario.Nombre @Model.usuario.Apellido1 @Model.usuario.Apellido2</h4>
                        <div class="text-start mt-3">
                            <div class="row mb-2">
                                <div class="col-sm-4"><strong>Usuario:</strong></div>
                                <div class="col-sm-8">@Model.usuario.UserName</div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-sm-4"><strong>Email:</strong></div>
                                <div class="col-sm-8">@Model.usuario.Email</div>
                            </div>
                            <div class="row">
                                <div class="col-sm-4"><strong>Cédula:</strong></div>
                                <div class="col-sm-8">@Model.usuario.Cedula</div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
    <!-- Card de Acciones centrada -->
    <div class="row">
        <div class="col-12 d-flex justify-content-center">
            <div class="card mt-4" style="width: 350px;">
                <div class="card-header">
                    <h5 class="mb-0">Acciones</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-danger" onclick="confirmarEliminar(@Model.IdPrestamo)" data-bs-toggle="modal" data-bs-target="#eliminarModal">
                            <i class="bi bi-trash"></i> Eliminar Préstamo
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmación para eliminar -->
<div class="modal fade" id="eliminarModal" tabindex="-1" aria-labelledby="eliminarModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="eliminarModalLabel">Confirmar Eliminación</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center">
                    <i class="bi bi-exclamation-triangle-fill text-warning" style="font-size: 3rem;"></i>
                    <h4 class="mt-3">¿Está seguro que desea eliminar este préstamo?</h4>
                    <p class="text-muted">Esta acción eliminará el préstamo y todos los registros relacionados. Esta acción no se puede deshacer.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <form id="formEliminar" method="post" style="display: inline;">
                    <button type="submit" class="btn btn-danger">Eliminar Préstamo</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    function confirmarEliminar(idPrestamo) {
        document.getElementById('formEliminar').action = '/Prestamo/EliminarPrestamo/' + idPrestamo;
    }
</script>
